<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.12: http://docutils.sourceforge.net/" />
<title>Suivi à distance de l'ouverture d'une porte de garage</title>
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 7614 2013-02-21 15:55:51Z milde $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

object[type="image/svg+xml"], object[type="application/x-shockwave-flash"] {
  overflow: hidden;
}

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title, .code .error {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left, .figure.align-left, object.align-left {
  clear: left ;
  float: left ;
  margin-right: 1em }

img.align-right, .figure.align-right, object.align-right {
  clear: right ;
  float: right ;
  margin-left: 1em }

img.align-center, .figure.align-center, object.align-center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.align-left {
  text-align: left }

.align-center {
  clear: both ;
  text-align: center }

.align-right {
  text-align: right }

/* reset inner alignment in figures */
div.align-right {
  text-align: inherit }

/* div.align-center * { */
/*   text-align: left } */

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font: inherit }

pre.literal-block, pre.doctest-block, pre.math, pre.code {
  margin-left: 2em ;
  margin-right: 2em }

pre.code .ln { color: grey; } /* line numbers */
pre.code, code { background-color: #eeeeee }
pre.code .comment, code .comment { color: #5C6576 }
pre.code .keyword, code .keyword { color: #3B0D06; font-weight: bold }
pre.code .literal.string, code .literal.string { color: #0C5404 }
pre.code .name.builtin, code .name.builtin { color: #352B84 }
pre.code .deleted, code .deleted { background-color: #DEB0A1}
pre.code .inserted, code .inserted { background-color: #A3D289}

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

/* "booktabs" style (no vertical lines) */
table.docutils.booktabs {
  border: 0px;
  border-top: 2px solid;
  border-bottom: 2px solid;
  border-collapse: collapse;
}
table.docutils.booktabs * {
  border: 0px;
}
table.docutils.booktabs th {
  border-bottom: thin solid;
  text-align: left;
}

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document" id="suivi-a-distance-de-l-ouverture-d-une-porte-de-garage">
<h1 class="title">Suivi à distance de l'ouverture d'une porte de garage</h1>

<p>Je suis équipé d'une porte de garage télécommandée. Bien que très pratique,
il m'est arrivé plusieurs fois d'appuyer par inadvertance sur la télécommande
(placée dans la poche) lorsque je suis dans la maison. Je ne m'aperçois pas
alors que la porte s'ouvre et reste ouverte.
Ce petit programme Python utilise un capteur de luminosité TSL 2561 connecté
à un <em>raspberry Pi</em> pour détecter l'ouverture de la porte et m'envoie un SMS
ou un mail pour m'avertir du changement de position.</p>
<div class="section" id="installation">
<h1>Installation</h1>
<div class="section" id="prerequis">
<h2>Prérequis</h2>
<p>Il faut avoir installé Python 3, avec le paquet venv :</p>
<pre class="literal-block">
pi&#64;raspi:~ $ sudo apt-get install python3-venv
pi&#64;raspi:~ $
</pre>
<p>Pour l'envoi de mails, il faut avoir configuré un programme <cite>sendmail</cite>. Le
paquet <a class="reference external" href="https://wiki.debian.org/sSMTP">ssmtp</a> est parfait pour cela.</p>
<p>Par ailleurs, il est possible d'enregister les mesures dans une base de
données tournante (rrdtool). Dans ce cas, il faut avoir installé librrd-dev.</p>
</div>
<div class="section" id="recuperation-des-sources">
<h2>Récupération des sources</h2>
<p>Les dernières sources sont sur Github&nbsp;:</p>
<pre class="literal-block">
pi&#64;raspi:~ $ git clone git&#64;github.com:christopheNan/garage.git
pi&#64;raspi:~ $ cd garage
pi&#64;raspi:~/garage $
</pre>
</div>
<div class="section" id="creation-d-un-environnement-virtuel">
<h2>Création d'un environnement virtuel</h2>
<p>Afin de ne pas interférer avec d'autres utilisations de Python sur le
Raspberry, nous créons un environnement virtuel&nbsp;:</p>
<pre class="literal-block">
pi&#64;raspi:~/garage $ mkdir -p ~/.Envs/ &amp;&amp; python3 -m venv ~/.Envs/garage/
pi&#64;raspi:~/garage $ . ~/.Envs/garage/bin/activate
(garage)pi&#64;raspi:~/garage $ pip install -r requirements.txt
</pre>
</div>
<div class="section" id="installation-en-tant-que-service-systemd">
<h2>Installation en tant que service systemd</h2>
<p>Afin que le programme soit lancé au démarrage du Pi et que son fonctionnement
soit surveillé, nous le lançons en tant que service systemd&nbsp;:</p>
<pre class="literal-block">
(garage)pi&#64;raspi:~/garage $ sudo cp garage.service /etc/systemd/system/
(garage)pi&#64;raspi:~/garage $ sudo mkdir -p /var/run/garage
(garage)pi&#64;raspi:~/garage $ sudo chown pi:pi /var/run/garage
</pre>
</div>
<div class="section" id="copie-du-fichier-de-configuration">
<h2>Copie du fichier de configuration</h2>
<p>En tant que service systemd, plaçons son fichier de configuration dans /etc&nbsp;:</p>
<pre class="literal-block">
(garage)pi&#64;raspi:~/garage $ sudo cp config.txt /etc/garage.conf
</pre>
</div>
</div>
<div class="section" id="fichier-de-configuration">
<h1>Fichier de configuration</h1>
<div class="section" id="section-serveur">
<h2>Section serveur</h2>
<p>Vous pouvez définir l'adresse sur laquelle écoute le serveur ainsi que le
port</p>
</div>
<div class="section" id="section-freemobile">
<h2>Section FreeMobile</h2>
<p><em>Merci Free</em>&nbsp;: nous pouvons envoyer gratuitement des SMS à notre numéro
abonné chez Free. Rendez-vous dans votre espace abonné Free pour activer le
service, obtenir un identifiant et un mot de passe.</p>
<ul class="simple">
<li>user :
identifiant obtenu dans l'espace abonné Free</li>
<li>password :
mot de passe obtenu dans l'espace abonné Free</li>
</ul>
</div>
<div class="section" id="section-mail">
<h2>Section Mail</h2>
<p>Si nous n'avons pas de mobile Free, nous pouvons quand même recevoir des
mails. Le programme utilise la commande <cite>sendmail</cite> pour envoyer des mails
(voir la section <a class="reference internal" href="#prerequis">Prérequis</a>).</p>
<ul class="simple">
<li>destinataires :
une liste d'adresses mail séparées par des virgules.</li>
</ul>
</div>
<div class="section" id="section-etats">
<h2>Section Etats</h2>
<p>Configurer ici les différents états que vous voulez reconnaître, dans l'ordre
croissant de la luminosité.</p>
</div>
<div class="section" id="section-capteur">
<h2>Section Capteur</h2>
<p>Le TSL2561 peut être configuré avec deux paramètres&nbsp;:</p>
<ul class="simple">
<li>temps d'intégration&nbsp;:
13, 101 ou 402 ms</li>
<li>gain&nbsp;:
1 ou 16</li>
</ul>
</div>
<div class="section" id="section-temps">
<h2>Section Temps</h2>
<p>Configurer ici&nbsp;:</p>
<ul class="simple">
<li>delay&nbsp;:
c'est l'intervalle de temps en secondes entre 2 mesures.</li>
<li>compteur&nbsp;:
c'est le nombre de mesures invalides consécutives avant d'envoyer un
message d'erreur.</li>
</ul>
</div>
<div class="section" id="section-programme">
<h2>Section Programme</h2>
<ul>
<li><p class="first">logging&nbsp;:
définissez ici le niveau des traces que vous souhaitez&nbsp;: DEBUG, INFO,
WARNING ou ERROR</p>
</li>
<li><p class="first">pid&nbsp;:
définissez ici le fichier dans lequel est stocké le PID du programme.</p>
<p>Ce paramètre est utilisé par systemd pour suivre le programme. Si vous
modifiez cette valeur, veillez à répercuter la modification dans le fichier
de configuration du service systemd (/etc/systemd/system/garage.service)</p>
</li>
</ul>
</div>
<div class="section" id="section-rrd">
<h2>Section rrd</h2>
<p>Les valeurs lues par le capteur peuvent être stockées dans une base de
données tournante. Spécifiez ici cette base de données</p>
</div>
</div>
<div class="section" id="etalonnage-du-capteur">
<h1>Étalonnage du capteur</h1>
<ul>
<li><p class="first">lancer le serveur web</p>
<pre class="literal-block">
(garage)pi&#64;raspi:~/garage $ python serveur.py
</pre>
</li>
<li><p class="first">étalonner le capteur avec les différentes positions</p>
</li>
</ul>
<pre class="literal-block">
utilisateur&#64;mon_pc:~ $ # porte fermée, lumière éteinte
utilisateur&#64;mon_pc:~ $ curl raspi:8080/
La lumière vaut 0.5
utilisateur&#64;mon_pc:~ $
utilisateur&#64;mon_pc:~ $ # porte fermée, lumière allumée
utilisateur&#64;mon_pc:~ $ curl raspi:8080/
La lumière vaut 0.6
utilisateur&#64;mon_pc:~ $
utilisateur&#64;mon_pc:~ $ # porte ouverte
utilisateur&#64;mon_pc:~ $ curl raspi:8080/
La lumière vaut 0.7
utilisateur&#64;mon_pc:~ $ ...
</pre>
</div>
<div class="section" id="test-du-service">
<h1>Test du service</h1>
<pre class="literal-block">
(garage)pi&#64;raspi:~/garage $ # obtenir l'aide sur les différentes options
(garage)pi&#64;raspi:~/garage $ python3 garage.py -h
(garage)pi&#64;raspi:~/garage $ python3 garage.py -f --log-level DEBUG
</pre>
</div>
<div class="section" id="gestion-du-service-systemd">
<h1>Gestion du service systemd</h1>
<ul class="simple">
<li>Lancement manuel du service&nbsp;:</li>
</ul>
<pre class="literal-block">
pi&#64;raspi:~/garage $ sudo systemctl start garage.service
</pre>
<ul class="simple">
<li>Vérification de l'état&nbsp;:</li>
</ul>
<pre class="literal-block">
pi&#64;raspi:~/garage $ sudo systemctl status garage.service
</pre>
<ul class="simple">
<li>Activation automatique au démarrage du raspberry&nbsp;:</li>
</ul>
<pre class="literal-block">
pi&#64;raspi:~/garage $ sudo systemctl enable garage.service
</pre>
</div>
<div class="section" id="licence">
<h1>Licence</h1>
<p>Ce logiciel est distribué sous la licence GPL v3.</p>
</div>
</div>
</body>
</html>
